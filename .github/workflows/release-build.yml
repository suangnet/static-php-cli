name: Build PHP Android ARM64

on:
  workflow_dispatch:
    inputs:
      debug:
        description: 'Enable Debug Mode'
        required: false
        default: false
        type: boolean

jobs:
  build-php:
    name: "Build PHP 8.4 for Android ARM64"
    runs-on: ubuntu-latest
    
    steps:
      - name: "Checkout Code"
        uses: actions/checkout@v4

      - name: "Setup PHP Builder"
        uses: shivammathur/setup-php@v2
        with:
          # UPDATE: Kita pakai PHP 8.4 di Runner agar warning deprecated hilang
          php-version: 8.4
          tools: composer:v2
          coverage: none

      - name: "Install Dependencies"
        run: composer update --no-interaction --no-progress --with-all-dependencies

      - name: "Download Sources (PHP + Libraries)"
        # FIX: Menghapus flag '--all-php' yang error.
        # Cukup pakai '--with-php' dan '--for-extensions'.
        run: |
          ./bin/spc download --with-php=8.4 --for-extensions="bcmath,ctype,curl,dom,exif,fileinfo,filter,gd,iconv,mbstring,mysqli,mysqlnd,opcache,openssl,pcntl,pdo,pdo_mysql,pdo_sqlite,phar,posix,session,simplexml,sockets,sqlite3,tokenizer,xml,xmlwriter,xmlreader,zip,zlib"

      - name: "Build Binary (via Docker)"
        # Menggunakan Docker untuk cross-compile ke ARM64 (Android)
        run: |
          ./bin/spc build \
            --build-os=linux \
            --build-php=8.4 \
            --arch=aarch64 \
            --with-docker \
            --extensions="bcmath,ctype,curl,dom,exif,fileinfo,filter,gd,iconv,mbstring,mysqli,mysqlnd,opcache,openssl,pcntl,pdo,pdo_mysql,pdo_sqlite,phar,posix,session,simplexml,sockets,sqlite3,tokenizer,xml,xmlwriter,xmlreader,zip,zlib"

      - name: "Get PHP Info & Rename"
        run: |
          # Rename file hasil agar mudah dikenali
          mv buildroot/bin/php php-8.4-android-arm64
          
          # Cek ukuran file untuk memastikan build sukses
          ls -lh php-8.4-android-arm64

      - name: "Upload Artifact"
        uses: actions/upload-artifact@v4
        with:
          name: php-8.4-android-arm64
          path: php-8.4-android-arm64
