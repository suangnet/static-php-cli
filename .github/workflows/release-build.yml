name: Build PHP Android ARM64

on:
  workflow_dispatch:
    inputs:
      debug:
        description: 'Enable Debug Mode'
        required: false
        default: false
        type: boolean

jobs:
  build-php:
    name: "Build PHP 8.4 for Android ARM64"
    runs-on: ubuntu-latest
    
    steps:
      - name: "Checkout Code"
        uses: actions/checkout@v4

      - name: "Set up QEMU"
        uses: docker/setup-qemu-action@v3

      - name: "Setup PHP (Host)"
        uses: shivammathur/setup-php@v2
        with:
          php-version: 8.3
          tools: composer:v2
          coverage: none

      - name: "Install Dependencies (Host)"
        run: composer update --no-interaction --no-progress --with-all-dependencies

      - name: "Download Sources (Host)"
        # Versi extension yang lebih ringkas agar build lebih cepat
        run: |
          ./bin/spc download --with-php=8.4 --for-extensions="bcmath,curl,dom,fileinfo,filter,gd,iconv,mbstring,mysqli,mysqlnd,opcache,openssl,pcntl,pdo,pdo_mysql,pdo_sqlite,phar,posix,session,simplexml,sockets,sqlite3,xml,zip,zlib"

      - name: "Build Binary inside ARM64 Container"
        uses: addnab/docker-run-action@v3
        with:
          image: alpine:edge
          options: --platform linux/arm64 -v ${{ github.workspace }}:/app -w /app
          run: |
            # Install dependency
            apk add --no-cache curl pkgconf php83 php83-cli php83-phar php83-mbstring php83-openssl php83-curl php83-tokenizer php83-dom php83-xml php83-xmlwriter composer build-base clang make cmake git linux-headers
            
            # Fix environment
            ./bin/spc doctor --auto-fix
            
            # Build dengan daftar extension yang sama
            ./bin/spc build --build-cli "bcmath,curl,dom,fileinfo,filter,gd,iconv,mbstring,mysqli,mysqlnd,opcache,openssl,pcntl,pdo,pdo_mysql,pdo_sqlite,phar,posix,session,simplexml,sockets,sqlite3,xml,zip,zlib"

      - name: "Get PHP Info & Rename"
        run: |
          # SOLUSI ERROR: Gunakan sudo chown untuk ambil alih permission file dari Docker
          echo "Mengambil alih permission file..."
          sudo chown -R $USER:$USER buildroot/
          
          echo "Memindahkan file..."
          mv buildroot/bin/php php-8.4-android-arm64
          
          echo "Cek hasil:"
          ls -lh php-8.4-android-arm64

      - name: "Upload Artifact"
        uses: actions/upload-artifact@v4
        with:
          name: php-8.4-android-arm64
          path: php-8.4-android-arm64
