name: Build PHP Android ARM64

on:
  workflow_dispatch:
    inputs:
      debug:
        description: 'Enable Debug Mode'
        required: false
        default: false
        type: boolean

jobs:
  build-php:
    name: "Build PHP 8.4 for Android ARM64"
    runs-on: ubuntu-latest
    
    steps:
      - name: "Checkout Code"
        uses: actions/checkout@v4

      - name: "Setup PHP"
        uses: shivammathur/setup-php@v2
        with:
          php-version: 8.2
          tools: composer:v2
          coverage: none

      - name: "Install Dependencies"
        run: composer update --no-interaction --no-progress

      - name: "Download Sources (PHP + Libraries)"
        # Kita download source code PHP dan library yang dibutuhkan
        run: |
          ./bin/spc download --all-php=8.4 --with-php=8.4 --for-extensions="bcmath,ctype,curl,dom,exif,fileinfo,filter,gd,iconv,mbstring,mysqli,mysqlnd,opcache,openssl,pcntl,pdo,pdo_mysql,pdo_sqlite,phar,posix,session,simplexml,sockets,sqlite3,tokenizer,xml,xmlwriter,xmlreader,zip,zlib"

      - name: "Build Binary (via Docker)"
        # Menggunakan flag --with-docker agar bisa build ARM64 di server x86
        run: |
          ./bin/spc build \
            --build-os=linux \
            --build-php=8.4 \
            --arch=aarch64 \
            --with-docker \
            --extensions="bcmath,ctype,curl,dom,exif,fileinfo,filter,gd,iconv,mbstring,mysqli,mysqlnd,opcache,openssl,pcntl,pdo,pdo_mysql,pdo_sqlite,phar,posix,session,simplexml,sockets,sqlite3,tokenizer,xml,xmlwriter,xmlreader,zip,zlib"

      - name: "Get PHP Info & Rename"
        run: |
          # Rename agar jelas
          mv buildroot/bin/php php-8.4-android-arm64
          
          # Cek ukuran file
          ls -lh php-8.4-android-arm64

      - name: "Upload Artifact"
        uses: actions/upload-artifact@v4
        with:
          name: php-8.4-android-arm64
          path: php-8.4-android-arm64
